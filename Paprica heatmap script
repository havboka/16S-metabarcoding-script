### HEATMAPS FOR METABOLIC INFERENCE (nitrogen pathways focused)

### METABOLIC INFERENCE HEAT MAPS

### attempt n1
install.packages("sysfonts")

library(sysfonts)
library(readr)
library(dplyr)
library(tidyr)
library(pheatmap)

#set the right working directory
setwd("/mnt/data/home/salvatorecampanile/paprica results files")

#### FOR ONE SAMPLE
#read one sample's pathways file
pathways_C01_L1 <- read_csv("C01-L1.bacteria.pathways.csv")

colnames(pathways_C01_L1)[1] <- "Pathway" # the first column is the pathway name,  so we need to change its name if it has not been done yet
head(pathways_C01_L1$Pathway)   # check first few pathway names

#read the summary pathways files
sum_pathways_C01_L1 <- read_csv("C01-L1.bacteria.sum_pathways.csv")

colnames(sum_pathways_C01_L1)[1] <- "Pathway" # the first column is the pathway name,  so we need to change its name if it has not been done yet
head(sum_pathways_C01_L1$Pathway)   # check first few pathway names

# Step 1: Categorize
pathways_grouped <- pathways_C01_L1 %>%
  mutate(Group = recode(Pathway,
                        "nitrogen fixation I (ferredoxin)" = "Nitrogen fixation",
                        "nitrogen fixation II (flavodoxin)" = "Nitrogen fixation",
                        "nitrate reduction I (denitrification)" = "Nitrate reduction (Denitrification)",
                        "nitrate reduction III (dissimilatory)" = "Nitrate reduction (Dissimilatory)",
                        "nitrate reduction IV (dissimilatory)" = "Nitrate reduction (Dissimilatory)",
                        "nitrate reduction IX (dissimilatory)" = "Nitrate reduction (Dissimilatory)",
                        "nitrate reduction X (dissimilatory)" = "Nitrate reduction (Dissimilatory)",
                        "nitrate reduction VIII (dissimilatory)" = "Nitrate reduction (Dissimilatory)",
                        "nitrate reduction VIIIb (dissimilatory)" = "Nitrate reduction (Dissimilatory)",
                        "nitrate reduction V (assimilatory)" = "Nitrate reduction (Assimilatory)",
                        "nitrate reduction VI (assimilatory)" = "Nitrate reduction (Assimilatory)",
                        "ammonia oxidation I (aerobic)" = "Ammonia Oxidation")) %>%
  group_by(Group) %>%
  summarise(across(where(is.numeric), sum, na.rm=TRUE))

# Step 2: Filter grouped pathways
nitrogen_pathways <- pathways_grouped %>%
  filter(Group %in% c("Nitrogen fixation", 
                      "Nitrate reduction (Denitrification)", 
                      "Nitrate reduction (Dissimilatory)", 
                      "Nitrate reduction (Assimilatory)", 
                      "Ammonia Oxidation"))

#let's plot
mat <- as.matrix(nitrogen_pathways[,-1])   # drop Pathway column
rownames(mat) <- nitrogen_pathways$Group

pheatmap(mat, cluster_rows=TRUE, cluster_cols=TRUE,
         main="Nitrogen metabolism pathways (C01-L1 sample)")

#### AUGUST ICE

## set the directory if you haven't done yet

files <- list.files(path="/mnt/data/home/salvatorecampanile/paprica results files", 
                    pattern=".bacteria.sum_pathways.csv", full.names=TRUE) #read all the files and discriminate for their names

# Re-read files with explicit column names
pathway_list <- lapply(files, function(f) {
  df <- read_csv(f, col_names = c("Pathway", "Abundance"), show_col_types = FALSE)
  
  # extract sample name: C01-L1, C02-L3, etc.
  sample_name <- str_extract(basename(f), "C[0-9]+-L[1-5]")
  
  df$Sample <- sample_name
  df
})

#combine into one big table
august_ice_pathways <- bind_rows(pathway_list)

#extract and replicate
august_ice_pathways <- august_ice_pathways %>%
  mutate(Layer = str_extract(Sample, "L[1-5]"))


#categorize pathways into nitrogen groups
august_ice_pathways_grouped <- august_ice_pathways %>%
  mutate(Group = recode(Pathway,
                        "nitrogen fixation I (ferredoxin)" = "Nitrogen fixation",
                        "nitrogen fixation II (flavodoxin)" = "Nitrogen fixation",
                        "nitrate reduction I (denitrification)" = "Nitrate reduction \n(Denitrification)",
                        "nitrate reduction III (dissimilatory)" = "Nitrate reduction \n(Dissimilatory)",
                        "nitrate reduction IV (dissimilatory)" = "Nitrate reduction \n(Dissimilatory)",
                        "nitrate reduction IX (dissimilatory)" = "Nitrate reduction \n(Dissimilatory)",
                        "nitrate reduction X (dissimilatory)" = "Nitrate reduction \n(Dissimilatory)",
                        "nitrate reduction VIII (dissimilatory)" = "Nitrate reduction \n(Dissimilatory)",
                        "nitrate reduction VIIIb (dissimilatory)" = "Nitrate reduction \n(Dissimilatory)",
                        "nitrate reduction V (assimilatory)" = "Nitrate reduction \n(Assimilatory)",
                        "nitrate reduction VI (assimilatory)" = "Nitrate reduction \n(Assimilatory)",
                        "ammonia oxidation I (aerobic)" = "Ammonia Oxidation"))

#nb the "\n" is used to separate sentences, titles or words in order to get them split across more lines

nitrogen_pathways_august <- august_ice_pathways_grouped %>%
  filter(Group %in% c("Nitrogen fixation", 
                      "Nitrate reduction \n(Denitrification)", 
                      "Nitrate reduction \n(Dissimilatory)", 
                      "Nitrate reduction \n(Assimilatory)", 
                      "Ammonia Oxidation"))


# Create custom depth labels attempt 2
layer_labels <- tibble(
  Layer = c("L1", "L2", "L3", "L4", "L5"),
  DepthLabel = c("Ice plug", "0–25 cm", "25–50 cm", "50–75 cm", "75–100 cm")
)

# Average + join labels attempt 2
layer_avg <- nitrogen_pathways_august %>%
  group_by(Group, Layer) %>%
  summarise(MeanAbundance = mean(Abundance, na.rm = TRUE), .groups = "drop") %>%
  left_join(layer_labels, by = "Layer") %>%
  mutate(
    DepthLabel = factor(
      DepthLabel,
      levels = c("Ice plug", "0–25 cm", "25–50 cm", "50–75 cm", "75–100 cm")
    )
  )

# Pivot using friendly depth names attempt 2
heatmap_data <- layer_avg %>%
  select(-Layer) %>%        # ← REMOVE Layer
  pivot_wider(
    names_from = DepthLabel,
    values_from = MeanAbundance,
    values_fill = 0
  )


#convert to matrix
mat <- as.matrix(heatmap_data[,-c(1)])
rownames(mat) <- heatmap_data$Group

print(heatmap_data)

#plot
pheatmap(
  mat,
  fontsize_row = 16,
  fontsize_col = 14,
  angle_col = 0,   # <-- makes column labels horizontal
  cluster_rows=TRUE,
  cluster_cols=FALSE,
         main="Nitrogen metabolism pathways August Ice",
  fontsize = 14
  )




### attempt for march ice

## set the directory if you haven't done yet

files <- list.files(path="/mnt/data/home/salvatorecampanile/paprica results files/march sum pathways", 
                    pattern=".bacteria.sum_pathways.csv", full.names=TRUE) #read all the files and discriminate for their names

# Re-read files with explicit column names
pathway_list <- lapply(files, function(f) {
  df <- read_csv(f, col_names = c("Pathway", "Abundance"), show_col_types = FALSE)
  
  # extract sample name: C01-L1, C02-L3, etc.
  sample_name <- str_extract(basename(f), "C[0-9]+-L[1-5]")
  
  df$Sample <- sample_name
  df
})

#combine into one big table
august_ice_pathways <- bind_rows(pathway_list)

#extract and replicate
august_ice_pathways <- august_ice_pathways %>%
  mutate(Layer = str_extract(Sample, "L[1-5]"))


#categorize pathways into nitrogen groups
august_ice_pathways_grouped <- august_ice_pathways %>%
  mutate(Group = recode(Pathway,
                        "nitrogen fixation I (ferredoxin)" = "Nitrogen fixation",
                        "nitrogen fixation II (flavodoxin)" = "Nitrogen fixation",
                        "nitrate reduction I (denitrification)" = "Nitrate reduction \n(Denitrification)",
                        "nitrate reduction III (dissimilatory)" = "Nitrate reduction \n(Dissimilatory)",
                        "nitrate reduction IV (dissimilatory)" = "Nitrate reduction \n(Dissimilatory)",
                        "nitrate reduction IX (dissimilatory)" = "Nitrate reduction \n(Dissimilatory)",
                        "nitrate reduction X (dissimilatory)" = "Nitrate reduction \n(Dissimilatory)",
                        "nitrate reduction VIII (dissimilatory)" = "Nitrate reduction \n(Dissimilatory)",
                        "nitrate reduction VIIIb (dissimilatory)" = "Nitrate reduction \n(Dissimilatory)",
                        "nitrate reduction V (assimilatory)" = "Nitrate reduction \n(Assimilatory)",
                        "nitrate reduction VI (assimilatory)" = "Nitrate reduction \n(Assimilatory)",
                        "ammonia oxidation I (aerobic)" = "Ammonia Oxidation"))


nitrogen_pathways_august <- august_ice_pathways_grouped %>%
  filter(Group %in% c("Nitrogen fixation", 
                      "Nitrate reduction \n(Denitrification)", 
                      "Nitrate reduction \n(Dissimilatory)", 
                      "Nitrate reduction \n(Assimilatory)", 
                      "Ammonia Oxidation"))


# Create custom depth labels attempt 2
layer_labels <- tibble(
  Layer = c("L1", "L2", "L3", "L4", "L5"),
  DepthLabel = c("Ice plug", "0–25 cm", "25–50 cm", "50–75 cm", "Last 25 cm")
)

# Average + join labels attempt 2
layer_avg <- nitrogen_pathways_august %>%
  group_by(Group, Layer) %>%
  summarise(MeanAbundance = mean(Abundance, na.rm = TRUE), .groups = "drop") %>%
  left_join(layer_labels, by = "Layer") %>%
  mutate(
    DepthLabel = factor(
      DepthLabel,
      levels = c("Ice plug", "0–25 cm", "25–50 cm", "50–75 cm", "Last 25 cm")
    )
  )

# Pivot using friendly depth names attempt 2
heatmap_data <- layer_avg %>%
  select(-Layer) %>%        # ← REMOVE Layer
  pivot_wider(
    names_from = DepthLabel,
    values_from = MeanAbundance,
    values_fill = 0
  )


#convert to matrix
mat <- as.matrix(heatmap_data[,-c(1)])
rownames(mat) <- heatmap_data$Group

print(heatmap_data)

#plot
pheatmap(
  mat,
  fontsize_row = 16,
  fontsize_col = 14,
  angle_col = 0,   # <-- makes column labels horizontal
  cluster_rows=FALSE,
  cluster_cols=FALSE,
  border_color = "white",
  main="Nitrogen metabolism pathways March Ice",
  fontsize = 14
)


### ==========================================================
###  Clustered heatmap grouped by month (March → May → August)
###  Columns = 6 enzymes per month (3 × 6 = 18)
###  Rows = depth layers
### ==========================================================

setwd("/mnt/data/home/salvatorecampanile/paprica results files")

library(tidyverse)
library(readxl)
library(pheatmap)

# ---------------------------
# 1. Load and filter data
# ---------------------------
df <- read_csv("nitrogen_cycle.csv")

enzymes <- c(
  "Nitrogenase.",
  "Nitrite reductase (NAD(P)H).",
  "Nitrite reductase (NO-forming).",
  "Nitrate reductase.",
  "Nitrate reductase (cytochrome).",
  "Urease."
)

df_filt <- df %>% filter(Enzyme_Name %in% enzymes)

# ---------------------------
# 2. Define sample groups
# ---------------------------
layer_samples <- list(
  March = list(
    L1 = c("C03-L1.", "C04-L1.", "C22-L1.", "C23-L1."),
    L2 = c("C03-L2.", "C04-L2.", "C22-L2.", "C23-L2."),
    L3 = c("C03-L3.", "C04-L3.", "C22-L3.", "C23-L3."),
    L4 = c("C03-L4.", "C04-L4.", "C22-L4.", "C23-L4."),
    L5 = c("C03-L5.", "C04-L5.", "C22-L5.", "C23-L5.")
  ),
  May = list(
    L1 = c("C05-L1.", "C21-L1."),
    L2 = c("C05-L2.", "C21-L2."),
    L3 = c("C05-L3.", "C21-L3."),
    L4 = c("C05-L4.", "C21-L4."),
    L5 = c("C05-L5.", "C21-L5.")
  ),
  August = list(
    L1 = c("C01-L1.", "C02-L1.", "C12-L1.", "C13-L1."),
    L2 = c("C01-L2.", "C02-L2.", "C12-L2.", "C13-L2."),
    L3 = c("C01-L3.", "C02-L3.", "C12-L3.", "C13-L3."),
    L4 = c("C01-L4.", "C02-L4.", "C12-L4.", "C13-L4."),
    L5 = c("C02-L5.", "C12-L5.", "C13-L5.")
  )
)

# ---------------------------
# 3. Function to calculate means per layer
# ---------------------------
compute_layer_means <- function(df, month) {
  ls <- layer_samples[[month]]
  
  out <- df %>%
    mutate(
      L1 = rowMeans(select(., all_of(ls$L1)), na.rm = TRUE),
      L2 = rowMeans(select(., all_of(ls$L2)), na.rm = TRUE),
      L3 = rowMeans(select(., all_of(ls$L3)), na.rm = TRUE),
      L4 = rowMeans(select(., all_of(ls$L4)), na.rm = TRUE),
      L5 = rowMeans(select(., all_of(ls$L5)), na.rm = TRUE)
    ) %>%
    select(Enzyme_Name, L1, L2, L3, L4, L5)
  
  colnames(out)[2:6] <- paste(month, colnames(out)[2:6], sep = "_")
  
  return(out)
}

# ---------------------------
# 4. Build merged dataframe
# ---------------------------
df_all <- reduce(
  list(
    compute_layer_means(df_filt, "March"),
    compute_layer_means(df_filt, "May"),
    compute_layer_means(df_filt, "August")
  ),
  full_join, 
  by = "Enzyme_Name"
)

# ---------------------------
# 5. Reshape: depth → rows, enzyme-month → columns
# ---------------------------
df_long <- df_all %>%
  pivot_longer(
    cols = -Enzyme_Name,
    names_to = c("Month", "Layer"),
    names_sep = "_",
    values_to = "Value"
  )

df_long$Layer <- factor(df_long$Layer,
                        levels = c("L1", "L2", "L3", "L4", "L5"),
                        labels = c("Ice plug", "0–25 cm", "25–50 cm", "50–75 cm", "Last 25 cm"))

# Create final column name: Enzyme_Month
df_long <- df_long %>%
  mutate(Column = paste(Enzyme_Name, Month, sep = "_"))

# Make wide matrix
heatmap_matrix <- df_long %>%
  select(Layer, Column, Value) %>%
  pivot_wider(names_from = Column, values_from = Value) %>%
  column_to_rownames("Layer") %>%
  as.matrix()

# ---------------------------
# 6. ORDER columns:
# March enzymes → May enzymes → August enzymes
# ---------------------------
month_order <- c("March", "May", "August")

ordered_cols <- heatmap_matrix %>%
  colnames() %>%
  sort(., method = "radix") %>%  # ensures alphabetical inside each month
  .[order(factor(sub(".*_", "", .), levels = month_order))]

heatmap_matrix <- heatmap_matrix[, ordered_cols]

orig_colnames <- ordered_cols

# Restore unique original names to ensure no duplicates
colnames(heatmap_matrix) <- orig_colnames

pretty_labels <- sub("_(March|May|August)$", "", orig_colnames)

month_labels <- sub(".*_", "", orig_colnames)

annotation_col <- data.frame(Month = month_labels)
rownames(annotation_col) <- orig_colnames


# ---------------------------
# 7. Column annotation (month labels)
# ---------------------------

# Extract month from ORIGINAL column names
month_labels <- sub(".*_", "", colnames(heatmap_matrix))

annotation_col <- data.frame(Month = month_labels)
rownames(annotation_col) <- colnames(heatmap_matrix)

annotation_colors <- list(
  Month = c(
    March = "#fec44f",
    May   = "#a1dab4",
    August = "#9ecae1"
  )
)


# ---------------------------
# 8. Final heatmap
# ---------------------------
palette <- colorRampPalette(c(
  "#f7fbff", "#deebf7", "#c6dbef",
  "#9ecae1", "#6baed6", "#3182bd"
))(100)

pheatmap(
  heatmap_matrix,
  color = palette,
  border_color = "white",
  cluster_rows = FALSE,
  cluster_cols = FALSE,
  annotation_col = annotation_col,
  annotation_colors = annotation_colors,
  cellwidth = 40,
  cellheight = 60,
  fontsize = 12,
  labels_col = pretty_labels,   # <-- SHOW nice labels
  main = "Nitrogen Cycle Enzyme Predicted Abundance"
)

